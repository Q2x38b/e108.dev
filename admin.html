<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Google Sheets Admin Console</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- Updated Content Security Policy: allow content-sheets.googleapis.com for framing -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' https://apis.google.com https://accounts.google.com https://www.gstatic.com https://content-sheets.googleapis.com; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://apis.google.com https://accounts.google.com https://www.gstatic.com; style-src 'self' 'unsafe-inline'; frame-src https://content-sheets.googleapis.com;">
    <style>
      /* Basic styling for the admin console */
      body {
        font-family: Arial, sans-serif;
        background: #f2f2f2;
        color: #333;
        margin: 0;
        padding: 20px;
      }
      .container {
        max-width: 960px;
        margin: auto;
        background: #fff;
        padding: 20px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      }
      table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 20px;
      }
      th,
      td {
        padding: 10px;
        border: 1px solid #ddd;
      }
      th {
        background: #f4f4f4;
      }
      input[type="text"],
      textarea {
        width: 100%;
        padding: 5px;
        box-sizing: border-box;
      }
      button {
        padding: 10px 20px;
        margin: 5px;
        cursor: pointer;
      }
      .controls {
        margin-bottom: 20px;
      }
      #form-section {
        margin-top: 20px;
        border: 1px solid #ddd;
        padding: 15px;
        background: #fafafa;
      }
    </style>
    <!-- Load the Google API client library for Sheets API -->
    <script src="https://apis.google.com/js/api.js"></script>
    <!-- Load the new Google Identity Services library -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
  </head>
  <body>
    <div class="container">
      <h1>Google Sheets Admin Console</h1>
      <div id="auth-status">
        <button id="authorize_button">Authorize</button>
        <button id="signout_button" style="display: none;">Sign Out</button>
      </div>
      <div class="controls" id="controls" style="display: none;">
        <button onclick="listSheetData()">Refresh Data</button>
        <button onclick="showNewRowForm()">Add New Entry</button>
      </div>
      <div id="content"></div>
      <div id="form-section" style="display: none;">
        <h2 id="form-title">Add/Edit Entry</h2>
        <form id="edit-form">
          <!-- Adjust these fields to match your sheet's columns -->
          <label>
            Date:
            <input type="text" id="entry_date" name="date" placeholder="YYYY-MM-DD" required />
          </label>
          <br /><br />
          <label>
            Title:
            <input type="text" id="entry_title" name="title" required />
          </label>
          <br /><br />
          <label>
            Content:
            <textarea id="entry_content" name="content" rows="4" required></textarea>
          </label>
          <br /><br />
          <button type="submit">Save Entry</button>
          <button type="button" onclick="cancelForm()">Cancel</button>
        </form>
      </div>
    </div>

    <script>
      // Replace these with your own API credentials
      const CLIENT_ID = '936331083814-8hv2h12vfd021st5frrvhav875mucps3.apps.googleusercontent.com';
      const API_KEY = 'AIzaSyApvQuAABFbVVDVWTOdVSrWWXhLAYeXyZo';

      // Discovery doc URL for Sheets API.
      const DISCOVERY_DOCS = ["https://sheets.googleapis.com/$discovery/rest?version=v4"];
      // Authorization scopes required by the API.
      const SCOPES = "https://www.googleapis.com/auth/spreadsheets";

      // Your Google Sheet ID and sheet name.
      const spreadsheetId = '1jyPppl4fiQeUUkPchckMdm4Q8m-PLLyNK7cV64ggMx0';
      const sheetName = 'Sheet1';

      const authorizeButton = document.getElementById('authorize_button');
      const signoutButton = document.getElementById('signout_button');
      let currentRowIndex = null; // For editing rows
      let tokenClient;
      let accessToken = null;

      // Initialize gapi.client and then the GIS token client once the window is fully loaded.
      function handleClientLoad() {
        gapi.load('client', initClient);
      }

      function initClient() {
        gapi.client.init({
          apiKey: API_KEY,
          discoveryDocs: DISCOVERY_DOCS,
        }).then(() => {
          // Initialize the GIS token client once gapi is ready.
          if (google?.accounts?.oauth2?.initTokenClient) {
            tokenClient = google.accounts.oauth2.initTokenClient({
              client_id: CLIENT_ID,
              scope: SCOPES,
              callback: (resp) => {
                if (resp.error) {
                  console.error(resp);
                  return;
                }
                accessToken = resp.access_token;
                gapi.client.setToken({ access_token: accessToken });
                // Show controls and load data once token is received.
                document.getElementById('controls').style.display = 'block';
                listSheetData();
                authorizeButton.style.display = 'none';
                signoutButton.style.display = 'block';
              },
            });
          } else {
            console.error('GIS library is not loaded.');
          }
        });
      }

      // Trigger token request on auth button click.
      function handleAuthClick() {
        if (tokenClient) {
          tokenClient.requestAccessToken();
        } else {
          console.error('Token client not initialized.');
        }
      }

      // Revoke token on sign-out.
      function handleSignoutClick() {
        if (accessToken) {
          google.accounts.oauth2.revoke(accessToken, () => {
            accessToken = null;
            gapi.client.setToken(null);
            document.getElementById('controls').style.display = 'none';
            document.getElementById('content').innerHTML = '';
            authorizeButton.style.display = 'block';
            signoutButton.style.display = 'none';
          });
        }
      }

      authorizeButton.onclick = handleAuthClick;
      signoutButton.onclick = handleSignoutClick;

      // List sheet data and display it in a table.
      function listSheetData() {
        gapi.client.sheets.spreadsheets.values.get({
          spreadsheetId: spreadsheetId,
          range: sheetName,
        }).then(
          function (response) {
            const range = response.result;
            if (range.values && range.values.length > 0) {
              displayData(range.values);
            } else {
              document.getElementById('content').innerHTML = 'No data found.';
            }
          },
          function (response) {
            console.error('Error: ' + response.result.error.message);
          }
        );
      }

      function displayData(data) {
        // Assume first row is headers.
        let html = '<table><thead><tr>';
        data[0].forEach(header => {
          html += '<th>' + header + '</th>';
        });
        html += '<th>Actions</th></tr></thead><tbody>';
        for (let i = 1; i < data.length; i++) {
          html += '<tr>';
          data[i].forEach(cell => {
            html += '<td>' + cell + '</td>';
          });
          html += '<td><button onclick="editRow(' + i + ')">Edit</button> ' +
                  '<button onclick="deleteRow(' + i + ')">Delete</button></td>';
          html += '</tr>';
        }
        html += '</tbody></table>';
        document.getElementById('content').innerHTML = html;
      }

      // Show the form for a new row.
      function showNewRowForm() {
        currentRowIndex = null;
        document.getElementById('form-title').textContent = 'Add New Entry';
        document.getElementById('edit-form').reset();
        document.getElementById('form-section').style.display = 'block';
      }

      // Edit an existing row.
      function editRow(rowIndex) {
        currentRowIndex = rowIndex;
        document.getElementById('form-title').textContent = 'Edit Entry';
        // Get the row data (assumes columns A:C).
        gapi.client.sheets.spreadsheets.values.get({
          spreadsheetId: spreadsheetId,
          range: sheetName + '!A' + (rowIndex + 1) + ':C' + (rowIndex + 1),
        }).then(function (response) {
          const rowData = response.result.values[0];
          document.getElementById('entry_date').value = rowData[0] || '';
          document.getElementById('entry_title').value = rowData[1] || '';
          document.getElementById('entry_content').value = rowData[2] || '';
          document.getElementById('form-section').style.display = 'block';
        });
      }

      // Handle form submission to add or update a row.
      document.getElementById('edit-form').addEventListener('submit', function (e) {
        e.preventDefault();
        const date = document.getElementById('entry_date').value;
        const title = document.getElementById('entry_title').value;
        const content = document.getElementById('entry_content').value;
        const values = [[date, title, content]];

        if (currentRowIndex === null) {
          // Append new row.
          gapi.client.sheets.spreadsheets.values.append({
            spreadsheetId: spreadsheetId,
            range: sheetName,
            valueInputOption: 'USER_ENTERED',
            insertDataOption: 'INSERT_ROWS',
            resource: { values: values },
          }).then(function (response) {
            alert('Entry added successfully!');
            document.getElementById('form-section').style.display = 'none';
            listSheetData();
          });
        } else {
          // Update existing row.
          const range = sheetName + '!A' + (currentRowIndex + 1) + ':C' + (currentRowIndex + 1);
          gapi.client.sheets.spreadsheets.values.update({
            spreadsheetId: spreadsheetId,
            range: range,
            valueInputOption: 'USER_ENTERED',
            resource: { values: values },
          }).then(function (response) {
            alert('Entry updated successfully!');
            document.getElementById('form-section').style.display = 'none';
            listSheetData();
          });
        }
      });

      function cancelForm() {
        document.getElementById('form-section').style.display = 'none';
      }

      // Delete a row using batchUpdate (Sheets API doesn’t offer a direct delete row method).
      function deleteRow(rowIndex) {
        if (!confirm('Are you sure you want to delete this entry?')) return;
        const requests = [{
          deleteDimension: {
            range: {
              sheetId: 0, // Adjust if necessary.
              dimension: 'ROWS',
              startIndex: rowIndex,
              endIndex: rowIndex + 1,
            },
          },
        }];
        gapi.client.sheets.spreadsheets.batchUpdate({
          spreadsheetId: spreadsheetId,
          resource: { requests: requests },
        }).then(function (response) {
          alert('Entry deleted successfully!');
          listSheetData();
        }, function (error) {
          console.error('Error deleting row: ', error);
        });
      }

      // Wait for the full window to load before initializing the client.
      window.addEventListener('load', handleClientLoad);
    </script>
  </body>
</html>
